name: Deploy to Server

on:
  push:
    branches:
      - dev

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Deploy to server via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USER }}
        password: ${{ secrets.SSH_PASSWORD }}
        # å¦‚æžœä½¿ç”¨ SSH å¯†é’¥è®¤è¯ï¼ˆæŽ¨èï¼‰ï¼Œå–æ¶ˆä¸‹é¢ä¸¤è¡Œçš„æ³¨é‡Šï¼Œå¹¶æ³¨é‡ŠæŽ‰ password
        # key: ${{ secrets.SSH_PRIVATE_KEY }}
        # passphrase: ${{ secrets.SSH_PASSPHRASE }}
        port: ${{ secrets.SSH_PORT || 22 }}
        timeout: 300s
        script: |
          set -e
          
          # é¢œè‰²å®šä¹‰
          RED='\033[0;31m'
          GREEN='\033[0;32m'
          YELLOW='\033[1;33m'
          BLUE='\033[0;34m'
          NC='\033[0m'
          
          echo -e "${BLUE}========================================${NC}"
          echo -e "${BLUE}  å¼€å§‹éƒ¨ç½²çŽ¯ä¿¡å›žè°ƒæœåŠ¡${NC}"
          echo -e "${BLUE}========================================${NC}"
          echo ""
          
          # æœåŠ¡å™¨ä¸Šçš„é¡¹ç›®ç›®å½•ï¼ˆå¯é€šè¿‡ secret é…ç½®ï¼‰
          # é»˜è®¤å€¼ $HOME/easemob_ai_agent ä¸Ž install.sh ä¸­çš„ DEFAULT_INSTALL_DIR ä¿æŒä¸€è‡´
          PROJECT_DIR="${SSH_PROJECT_DIR:-$HOME/easemob_ai_agent}"
          DEPLOY_TYPE="${SSH_DEPLOY_TYPE:-local}"
          
          echo -e "${BLUE}[INFO]${NC} é¡¹ç›®ç›®å½•: $PROJECT_DIR"
          echo -e "${BLUE}[INFO]${NC} éƒ¨ç½²æ–¹å¼: $DEPLOY_TYPE"
          echo -e "${BLUE}[INFO]${NC} Git æäº¤: ${{ github.sha }}"
          echo ""
          
          # åˆ›å»ºé¡¹ç›®ç›®å½•ï¼ˆå¦‚æžœä¸å­˜åœ¨ï¼‰
          mkdir -p "$PROJECT_DIR"
          cd "$PROJECT_DIR"
          
          # å¦‚æžœç›®å½•ä¸å­˜åœ¨æˆ–æ˜¯ç©ºç›®å½•ï¼Œå…‹éš†ä»“åº“
          if [ ! -d ".git" ]; then
            echo -e "${BLUE}[INFO]${NC} é¦–æ¬¡éƒ¨ç½²ï¼Œå…‹éš†ä»“åº“..."
            git clone https://github.com/dujiepeng/easemob_ai_agent.git "$PROJECT_DIR" || {
              echo -e "${YELLOW}[WARNING]${NC} å…‹éš†å¤±è´¥ï¼Œå°è¯•åˆå§‹åŒ–..."
              rm -rf "$PROJECT_DIR"/*
              git clone https://github.com/dujiepeng/easemob_ai_agent.git .
            }
          else
            echo -e "${BLUE}[INFO]${NC} åˆ‡æ¢åˆ° dev åˆ†æ”¯å¹¶æ›´æ–°ä»£ç ..."
            git fetch origin dev || git fetch origin
            git checkout -B dev origin/dev 2>/dev/null || git checkout -b dev || git checkout dev
            git reset --hard origin/dev
            git clean -fd
          fi
          
          # ç¡®ä¿ .env æ–‡ä»¶å­˜åœ¨ï¼ˆå¦‚æžœä¸å­˜åœ¨åˆ™ä»Žç¤ºä¾‹å¤åˆ¶ï¼Œä½†ä¸ä¼šè¦†ç›–å·²æœ‰é…ç½®ï¼‰
          if [ ! -f ".env" ]; then
            echo -e "${YELLOW}[WARNING]${NC} .env æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä»Žç¤ºä¾‹å¤åˆ¶..."
            if [ -f "env.example" ]; then
              cp env.example .env
              echo -e "${YELLOW}[WARNING]${NC} è¯·ç¡®ä¿åœ¨æœåŠ¡å™¨ä¸Šé…ç½®æ­£ç¡®çš„ .env æ–‡ä»¶å†…å®¹"
            else
              echo -e "${RED}[ERROR]${NC} env.example æ–‡ä»¶ä¸å­˜åœ¨"
              exit 1
            fi
          fi
          
          # æ ¹æ®éƒ¨ç½²æ–¹å¼æ‰§è¡Œä¸åŒçš„éƒ¨ç½²æ­¥éª¤
          if [ "$DEPLOY_TYPE" = "docker" ]; then
            echo -e "${BLUE}[INFO]${NC} ä½¿ç”¨ Docker æ–¹å¼éƒ¨ç½²..."
            
            # æ£€æŸ¥ Docker å’Œ docker-compose
            if ! command -v docker &> /dev/null; then
              echo -e "${RED}[ERROR]${NC} Docker æœªå®‰è£…"
              exit 1
            fi
            
            if ! command -v docker-compose &> /dev/null; then
              echo -e "${RED}[ERROR]${NC} docker-compose æœªå®‰è£…"
              exit 1
            fi
            
            # åœæ­¢çŽ°æœ‰æœåŠ¡
            echo -e "${BLUE}[INFO]${NC} åœæ­¢çŽ°æœ‰æœåŠ¡..."
            cd "$PROJECT_DIR"
            docker-compose down || true
            
            # æž„å»ºå¹¶å¯åŠ¨
            echo -e "${BLUE}[INFO]${NC} æž„å»º Docker é•œåƒ..."
            docker-compose build --no-cache
            
            echo -e "${BLUE}[INFO]${NC} å¯åŠ¨æœåŠ¡..."
            docker-compose up -d
            
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo -e "${BLUE}[INFO]${NC} ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 10
            
            # æ£€æŸ¥æœåŠ¡çŠ¶æ€
            if docker-compose ps | grep -q "Up"; then
              echo -e "${GREEN}[SUCCESS]${NC} Docker æœåŠ¡å¯åŠ¨æˆåŠŸï¼"
              echo ""
              docker-compose ps
              echo ""
              
              # å¥åº·æ£€æŸ¥
              if command -v curl &> /dev/null; then
                sleep 3
                if curl -f -s http://localhost:9999/health > /dev/null 2>&1; then
                  echo -e "${GREEN}[SUCCESS]${NC} å¥åº·æ£€æŸ¥é€šè¿‡"
                else
                  echo -e "${YELLOW}[WARNING]${NC} å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœåŠ¡æ—¥å¿—"
                fi
              fi
            else
              echo -e "${RED}[ERROR]${NC} Docker æœåŠ¡å¯åŠ¨å¤±è´¥"
              docker-compose logs
              exit 1
            fi
            
          else
            # æœ¬åœ°éƒ¨ç½²æ–¹å¼
            echo -e "${BLUE}[INFO]${NC} ä½¿ç”¨æœ¬åœ°æ–¹å¼éƒ¨ç½²..."
            
            # æ£€æŸ¥ Node.js å’Œ npm
            NODE_CMD=""
            if command -v node &> /dev/null; then
              NODE_CMD="node"
            elif command -v nodejs &> /dev/null; then
              NODE_CMD="nodejs"
            else
              echo -e "${RED}[ERROR]${NC} Node.js æœªå®‰è£…"
              exit 1
            fi
            
            if ! command -v npm &> /dev/null; then
              echo -e "${RED}[ERROR]${NC} npm æœªå®‰è£…"
              exit 1
            fi
            
            # æ£€æŸ¥ Node.js ç‰ˆæœ¬
            NODE_VERSION=$($NODE_CMD -v | sed 's/v//' | cut -d. -f1)
            if [ -z "$NODE_VERSION" ] || [ "$NODE_VERSION" -lt 16 ]; then
              echo -e "${RED}[ERROR]${NC} Node.js ç‰ˆæœ¬éœ€è¦ >= 16.0.0ï¼Œå½“å‰: $($NODE_CMD -v)"
              exit 1
            fi
            
            echo -e "${BLUE}[INFO]${NC} Node.js ç‰ˆæœ¬: $($NODE_CMD -v), npm ç‰ˆæœ¬: $(npm -v)"
            
            # åˆ›å»ºå¿…è¦çš„ç›®å½•
            cd "$PROJECT_DIR"
            mkdir -p logs data
            
            # å®‰è£…/æ›´æ–°ä¾èµ–
            echo -e "${BLUE}[INFO]${NC} å®‰è£…ä¾èµ–..."
            npm ci --production || npm install --production
            
            # åœæ­¢çŽ°æœ‰æœåŠ¡ï¼ˆå¦‚æžœå­˜åœ¨ PID æ–‡ä»¶ï¼‰
            if [ -f ".pid" ]; then
              OLD_PID=$(cat .pid)
              if ps -p "$OLD_PID" > /dev/null 2>&1; then
                echo -e "${BLUE}[INFO]${NC} åœæ­¢çŽ°æœ‰æœåŠ¡ (PID: $OLD_PID)..."
                kill "$OLD_PID" || true
                sleep 2
                # å¦‚æžœè¿›ç¨‹ä»åœ¨è¿è¡Œï¼Œå¼ºåˆ¶æ€æ­»
                if ps -p "$OLD_PID" > /dev/null 2>&1; then
                  kill -9 "$OLD_PID" || true
                  sleep 1
                fi
              fi
              rm -f .pid
            fi
            
            # æ£€æŸ¥ç«¯å£å ç”¨å¹¶æ¸…ç†
            PORT=$(grep "^PORT=" .env 2>/dev/null | cut -d'=' -f2 || echo "3000")
            PORT=${PORT:-3000}
            echo -e "${BLUE}[INFO]${NC} æ£€æŸ¥ç«¯å£ $PORT..."
            
            if command -v lsof &> /dev/null; then
              OLD_PORT_PID=$(lsof -ti:$PORT 2>/dev/null || true)
              if [ -n "$OLD_PORT_PID" ] && [ "$OLD_PORT_PID" != "$OLD_PID" ]; then
                echo -e "${YELLOW}[WARNING]${NC} ç«¯å£ $PORT è¢«è¿›ç¨‹ $OLD_PORT_PID å ç”¨ï¼Œå°è¯•åœæ­¢..."
                kill "$OLD_PORT_PID" || kill -9 "$OLD_PORT_PID" || true
                sleep 2
              fi
            fi
            
            # å¯åŠ¨æœåŠ¡
            echo -e "${BLUE}[INFO]${NC} å¯åŠ¨æœåŠ¡..."
            nohup npm start > logs/app.log 2>&1 &
            NEW_PID=$!
            echo $NEW_PID > .pid
            
            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo -e "${BLUE}[INFO]${NC} ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 5
            
            # æ£€æŸ¥æœåŠ¡çŠ¶æ€
            if ps -p "$NEW_PID" > /dev/null 2>&1; then
              echo -e "${GREEN}[SUCCESS]${NC} æœåŠ¡å¯åŠ¨æˆåŠŸï¼(PID: $NEW_PID)"
              
              # å¥åº·æ£€æŸ¥
              if command -v curl &> /dev/null; then
                sleep 2
                if curl -f -s "http://localhost:$PORT/health" > /dev/null 2>&1; then
                  echo -e "${GREEN}[SUCCESS]${NC} å¥åº·æ£€æŸ¥é€šè¿‡"
                else
                  echo -e "${YELLOW}[WARNING]${NC} å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œä½†è¿›ç¨‹æ­£åœ¨è¿è¡Œ"
                  echo -e "${BLUE}[INFO]${NC} æŸ¥çœ‹æ—¥å¿—: tail -f $PROJECT_DIR/logs/app.log"
                fi
              fi
            else
              echo -e "${RED}[ERROR]${NC} æœåŠ¡å¯åŠ¨å¤±è´¥"
              echo -e "${BLUE}[INFO]${NC} æœ€åŽ50è¡Œæ—¥å¿—:"
              tail -n 50 logs/app.log || true
              exit 1
            fi
          fi
          
          echo ""
          echo -e "${GREEN}========================================${NC}"
          echo -e "${GREEN}  éƒ¨ç½²å®Œæˆï¼${NC}"
          echo -e "${GREEN}========================================${NC}"
          
    - name: Deployment Summary
      if: success()
      run: |
        echo "## ðŸš€ éƒ¨ç½²å®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **åˆ†æ”¯**: dev" >> $GITHUB_STEP_SUMMARY
        echo "- **æäº¤**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
        echo "- **æäº¤ä¿¡æ¯**: ${{ github.event.head_commit.message }}" >> $GITHUB_STEP_SUMMARY
        echo "- **æ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
        echo "- **æœåŠ¡å™¨**: \`${{ secrets.SSH_HOST }}\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… éƒ¨ç½²æˆåŠŸå®Œæˆï¼" >> $GITHUB_STEP_SUMMARY
